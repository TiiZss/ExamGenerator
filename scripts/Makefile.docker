# ExamGenerator - Docker Makefile
# Comandos simplificados para gestionar el stack Docker

.PHONY: help build up down restart logs shell web generate ai-generate clean prune

# ============================================
# Variables
# ============================================
PROJECT_NAME = examgenerator
COMPOSE = docker-compose
IMAGE_NAME = examgenerator:12.20260111

# ============================================
# Ayuda
# ============================================
help: ## Mostrar esta ayuda
	@echo "ExamGenerator - Docker Commands"
	@echo "================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ============================================
# Build & Deploy
# ============================================
build: ## Construir las im√°genes Docker
	@echo "üî® Construyendo im√°genes..."
	$(COMPOSE) build --no-cache

build-fast: ## Construir (sin cache solo si necesario)
	@echo "‚ö° Construyendo r√°pido..."
	$(COMPOSE) build

up: ## Iniciar todos los contenedores
	@echo "üöÄ Iniciando ExamGenerator stack..."
	$(COMPOSE) up -d app web
	@echo "‚úÖ Stack iniciado!"
	@echo "üìä Web UI: http://localhost:5000"
	@$(COMPOSE) ps

up-ai: ## Iniciar stack completo con IA (Gemini + Ollama)
	@echo "üöÄ Iniciando stack completo con IA..."
	$(COMPOSE) --profile ai up -d
	@echo "‚úÖ Stack con IA iniciado!"
	@$(COMPOSE) ps

up-ollama: ## Iniciar stack con Ollama
	@echo "üöÄ Iniciando stack con Ollama..."
	$(COMPOSE) --profile ollama up -d
	@echo "‚úÖ Stack con Ollama iniciado!"
	@$(COMPOSE) ps

down: ## Detener todos los contenedores
	@echo "üõë Deteniendo contenedores..."
	$(COMPOSE) down

restart: ## Reiniciar todos los contenedores
	@echo "üîÑ Reiniciando..."
	$(COMPOSE) restart

# ============================================
# Logs & Monitoring
# ============================================
logs: ## Ver logs de todos los contenedores
	$(COMPOSE) logs -f

logs-app: ## Ver logs del contenedor App
	$(COMPOSE) logs -f app

logs-web: ## Ver logs del contenedor Web
	$(COMPOSE) logs -f web

logs-ai: ## Ver logs de contenedores IA
	$(COMPOSE) logs -f ai-gemini ai-ollama

ps: ## Listar contenedores en ejecuci√≥n
	@$(COMPOSE) ps

# ============================================
# Shell & Debugging
# ============================================
shell: ## Abrir shell en el contenedor App
	@echo "üêö Abriendo shell en ExGen-App..."
	$(COMPOSE) exec app /bin/bash

shell-web: ## Abrir shell en el contenedor Web
	@echo "üêö Abriendo shell en ExGen-Web..."
	$(COMPOSE) exec web /bin/bash

shell-root: ## Abrir shell como root en App
	@echo "üêö Abriendo shell root en ExGen-App..."
	$(COMPOSE) exec --user root app /bin/bash

# ============================================
# Comandos de ExamGenerator
# ============================================
info: ## Mostrar informaci√≥n del sistema
	@echo "‚ÑπÔ∏è Informaci√≥n del sistema..."
	$(COMPOSE) run --rm app cli.py info

validate: ## Validar archivo de preguntas (uso: make validate FILE=preguntas.txt)
	@if [ -z "$(FILE)" ]; then \
		echo "‚ùå Error: Especifica FILE=ruta/archivo.txt"; \
		exit 1; \
	fi
	@echo "‚úÖ Validando $(FILE)..."
	$(COMPOSE) run --rm app cli.py validate /data/questions/$(FILE)

generate: ## Generar ex√°menes (uso: make generate FILE=preguntas.txt PREFIX=Parcial NUM=3 Q=10)
	@if [ -z "$(FILE)" ] || [ -z "$(PREFIX)" ]; then \
		echo "‚ùå Error: Especifica FILE=archivo.txt PREFIX=Parcial [NUM=3] [Q=10]"; \
		exit 1; \
	fi
	@echo "üìù Generando ex√°menes..."
	$(COMPOSE) run --rm -v $$(pwd)/output:/output app cli.py generate \
		/data/questions/$(FILE) $(PREFIX) $(or $(NUM),3) $(or $(Q),10) \
		--format both --answers html

ai-generate: ## Generar preguntas con IA (uso: make ai-generate FILE=documento.pdf NUM=10)
	@if [ -z "$(FILE)" ]; then \
		echo "‚ùå Error: Especifica FILE=documento.pdf [NUM=10]"; \
		exit 1; \
	fi
	@echo "ü§ñ Generando preguntas con IA..."
	$(COMPOSE) run --rm ai-gemini cli.py ai-generate \
		/data/questions/$(FILE) --num-questions $(or $(NUM),10) \
		--output /output/preguntas_ia.txt

web: ## Abrir navegador en la interfaz web
	@echo "üåê Abriendo http://localhost:5000"
	@python -m webbrowser http://localhost:5000 2>/dev/null || \
		xdg-open http://localhost:5000 2>/dev/null || \
		open http://localhost:5000 2>/dev/null || \
		echo "Abre manualmente: http://localhost:5000"

# ============================================
# Limpieza
# ============================================
clean: ## Limpiar outputs generados
	@echo "üßπ Limpiando archivos generados..."
	rm -rf output/Examenes_*
	rm -rf output/*.txt output/*.xlsx output/*.html output/*.docx

clean-logs: ## Limpiar logs
	@echo "üßπ Limpiando logs..."
	$(COMPOSE) exec app rm -rf /app/logs/*.log

prune: ## Limpieza profunda de Docker
	@echo "‚ö†Ô∏è  ADVERTENCIA: Esto eliminar√° contenedores, im√°genes y vol√∫menes sin usar"
	@read -p "¬øContinuar? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker system prune -af --volumes; \
		echo "‚úÖ Limpieza completada"; \
	fi

# ============================================
# Instalaci√≥n de modelos Ollama
# ============================================
ollama-pull: ## Descargar modelo Ollama (uso: make ollama-pull MODEL=llama2)
	@if [ -z "$(MODEL)" ]; then \
		echo "‚ùå Error: Especifica MODEL=nombre_modelo"; \
		exit 1; \
	fi
	@echo "‚¨áÔ∏è Descargando modelo $(MODEL)..."
	$(COMPOSE) exec ollama ollama pull $(MODEL)

ollama-list: ## Listar modelos Ollama instalados
	@echo "üìã Modelos instalados:"
	$(COMPOSE) exec ollama ollama list

ollama-rm: ## Eliminar modelo Ollama (uso: make ollama-rm MODEL=llama2)
	@if [ -z "$(MODEL)" ]; then \
		echo "‚ùå Error: Especifica MODEL=nombre_modelo"; \
		exit 1; \
	fi
	$(COMPOSE) exec ollama ollama rm $(MODEL)

# ============================================
# Testing & Development
# ============================================
test: ## Ejecutar tests dentro del contenedor
	@echo "üß™ Ejecutando tests..."
	$(COMPOSE) run --rm app pytest tests/ -v

dev: ## Modo desarrollo (hot reload)
	@echo "üî• Modo desarrollo..."
	$(COMPOSE) -f docker-compose.yml -f docker-compose.dev.yml up

# ============================================
# Configuraci√≥n
# ============================================
config-show: ## Mostrar configuraci√≥n actual
	$(COMPOSE) run --rm app cli.py config --show

config-create: ## Crear archivo de configuraci√≥n
	$(COMPOSE) run --rm app cli.py config --create

env-example: ## Crear archivo .env desde ejemplo
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "‚úÖ Archivo .env creado. Ed√≠talo con tus valores."; \
	else \
		echo "‚ö†Ô∏è .env ya existe"; \
	fi

# ============================================
# Backup & Restore
# ============================================
backup: ## Crear backup de outputs
	@echo "üíæ Creando backup..."
	@mkdir -p backups
	@tar -czf backups/examgen-backup-$$(date +%Y%m%d-%H%M%S).tar.gz output/
	@echo "‚úÖ Backup creado en backups/"

# ============================================
# Ejemplos r√°pidos
# ============================================
demo: ## Demo completo: validar + generar
	@echo "üé¨ Demo de ExamGenerator..."
	@$(MAKE) validate FILE=preguntas.txt
	@$(MAKE) generate FILE=preguntas.txt PREFIX=Demo NUM=2 Q=5
	@echo "‚úÖ Demo completado. Revisa output/"

# ============================================
# Versi√≥n
# ============================================
version: ## Mostrar versi√≥n
	@echo "ExamGenerator v12.20260111"
	@echo "Docker Stack con prefijo: ExGen-"
